---------------------5. Teen Students
--Select all students who are teenagers (their age is above or equal to 12). 
--Order them by first name (alphabetically), then by last name (alphabetically). 
--Select their first name, last name and their age.

SELECT FirstName, LastName, Age
FROM Students
WHERE Age >= 12
ORDER BY FirstName, LastName

---------------------6. Cool Addresses
--Select all full names from students, whose address text contains ‘road’.
--Order them by first name (alphabetically), then by last name (alphabetically), 
--then by address text (alphabetically).

SELECT CONCAT(FirstName, ' ', MiddleName, ' ', LastName), [Address]
FROM Students
WHERE [Address] LIKE '%Road%'
ORDER BY FirstName, LastName, [Address]

---------------------7. 42 Phones
--Select students with middle names whose phones starts with 42. 
--Select their first name, address and phone number. Order them by first name alphabetically.

SELECT FirstName, [Address], Phone
FROM Students
WHERE Phone LIKE '42%' AND (MiddleName IS NOT NULL)
ORDER BY FirstName

---------------------8. Students Teachers
--Select all students and the count of teachers each one has. 

SELECT s.FirstName, s.LastName, COUNT(st.TeacherId)
FROM Students AS s
JOIN StudentsTeachers AS st ON st.StudentId = s.Id
GROUP BY s.FirstName, s.LastName

---------------------9. Subjects with Students
--Select all teachers’ full names and the subjects they teach with the count of lessons in each
--.Finally select the count of students each teacher has. Order them by students count descending,
--full name (ascending) and subjects (ascending).

SELECT t.FirstName + ' ' + t.LastName AS FullName
	,s.Name + '-' + CAST(s.Lessons AS nvarchar(5)) AS Subjects
	,COUNT(st.StudentId) AS Students
FROM Teachers AS t
JOIN Subjects AS s ON t.SubjectId = s.Id
JOIN StudentsTeachers AS st ON t.Id = st.TeacherId
GROUP BY t.FirstName, t.LastName, s.Name, s.Lessons
ORDER BY COUNT(st.StudentId) DESC, FullName, Subjects

---------------------10. Students to Go
--Find all students, who have not attended an exam. Select their full name (first name + last name).
--Order the results by full name (ascending).

SELECT s.FirstName + ' ' + s.LastName AS [Full Name] 
FROM Students AS s
LEFT JOIN StudentsExams AS se ON se.StudentId = s.Id
WHERE se.ExamId IS NULL
ORDER BY [Full Name] 

---------------------11. Busiest Teachers
--Find top 10 teachers with most students they teach. Select their first name,
--last name and the amount of students they have. Order them by students count 
--(descending), then by first name (ascending), then by last name (ascending).

SELECT TOP(10) t.FirstName, t.LastName, Count(st.StudentId) AS [StudentsCount]
FROM Teachers AS t
JOIN StudentsTeachers AS st ON st.TeacherId = t.Id
GROUP BY t.FirstName, t.LastName
ORDER BY Count(st.StudentId) DESC, t.FirstName, t.LastName

---------------------12. Top Students
--Find top 10 students, who have highest average grades from the exams.
--Format the grade, two symbols after the decimal point.
--Order them by grade (descending), then by first name (ascending), then by last name (ascending)

SELECT TOP 10 s.FirstName, s.LastName, CAST(AVG(se.Grade) AS DECIMAL(18, 2)) AS [Grade]
FROM Students AS s
JOIN StudentsExams AS se ON se.StudentId = s.Id
--JOIN Exams AS e ON e.Id = se.ExamId
GROUP BY s.FirstName, s.LastName
ORDER BY AVG(se.Grade) DESC, s.FirstName, s.LastName

---------------------13. Second Highest Grade
--Find the second highest grade per student from all subjects. 
--Sort them by first name (ascending), then by last name (ascending).

SELECT t.FirstName, t.LastName, t.Grade
FROM 
	(
		SELECT s.FirstName
			,s.LastName
			,ss.Grade
			,ROW_NUMBER() OVER (PARTITION BY FirstName, LastName ORDER BY Grade DESC) AS RowNumber
		FROM Students AS s
		JOIN StudentsSubjects AS ss ON ss.StudentId = s.Id
	) AS t
WHERE t.RowNumber = 2
ORDER BY t.FirstName, t.LastName

---------------------14. Not So In The Studying
--Find all students who don’t have any subjects. Select their full name. 
--The full name is combination of first name, middle name and last name. 
--Order the result by full name
--NOTE: If the middle name is null you have to concatenate the first 
--name and last name separated with single space.

